---
title: "Blast virus NT report"
date: "`r Sys.Date()`"
params:
  rmd: "taxonomy_report.Rmd"
output: 
  html_document:
    theme: united
    highlight: tango
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r}
library(tidyverse)
library(DT)
library(formattable)
input_1 <- file.path("..", snakemake@input[[1]])
known_taxa <- read_csv(input_1)
```

## Sample `r snakemake@params[[1]]`

### Number of unique queries per tax_id
**Only top hits were selected**. Only scientific names were used for summary.

```{r}
taxa_sci <- filter(known_taxa, str_detect(name_class, "scientific"))
```

```{r, fig.cap="Number of sequence reads (unique queries) per tax_id."}
seq_reads <- taxa_sci %>%
  group_by(tax_id, unique_name) %>%
  summarise(N = n(),
            `%` = percent(N / nrow(.))) %>%
  ungroup() %>%
  arrange(desc(N)) %>% 
  formattable()
seq_reads %>% 
  as.datatable(rownames = FALSE, caption = paste0("Number of sequence reads (unique queries) per tax_id. Number of unique tax_id-s is ", nrow(seq_reads),"."))
```

Drop queries and get distinct gi-s:
```{r}
by_gi <- taxa_sci %>%
  group_by(gi, tax_id, unique_name) %>% 
 summarise(N = n(),
            `%` = percent(N / nrow(.))) %>%
  ungroup() %>%
  arrange(desc(N)) %>% 
  formattable()
by_gi %>% 
  as.datatable(rownames = FALSE, caption = paste0("Number of tax_id per top hit gi (unique top hit). Number of unique top hits ", nrow(by_gi), "."))
```

Add names of parent taxa.
```{r}
input_names <- file.path("..", snakemake@input[["names"]])
names <- read_csv(input_names)
```

```{r}
parent_sci <- filter(names, tax_id %in% taxa_sci$parent_tax_id,
                       str_detect(name_class, "scientific")) %>% 
  select(-name_class)
colnames(parent_sci) <- paste0("parent_", colnames(parent_sci))
parent_taxa <- left_join(taxa_sci, parent_sci)
```

### Number of unique queries per parent tax_id

```{r}
unique_parents <- parent_taxa %>%
  group_by(parent_tax_id, parent_unique_name) %>%
  summarise(N = n(),
            `%` = percent(N / nrow(.))) %>%
  ungroup() %>%
  arrange(desc(N)) %>% 
  formattable()
unique_parents %>% 
  as.datatable(rownames = FALSE, caption = paste0("Number of sequence reads (unique queries) per parent tax_id-s. Number of unique parent tax_id-s is ", nrow(unique_parents),"."))
```

### Number of phage and other virus hits

Approximate number of tax_id-s belonging to virus or bacteriophage class. In addition to explicit phages, putative bacterial virus names were detected using following regular expression `phag|bac|esch|coccu|chla|mona|erw|lis|vibr|shi|yers|salm|phi|clos|chla` and assigned to phage class.
```{r}
bac_reg <- "bac|esch|coccu|chla|mona|erw|lis|vibr|shi|yers|salm|phi|clos|chla"
phage_or_virus <- taxa_sci %>%
  mutate(name_txt = str_to_lower(name_txt),
         Class = case_when(
           (str_detect(name_txt, "phag") | str_detect(name_txt, bac_reg)) ~ "phage",
           (str_detect(name_txt, "vir") & !str_detect(name_txt, bac_reg)) ~ "virus",
           TRUE ~ name_txt
         )) %>%
  group_by(Class) %>%
  summarise(N = n(),
            `%` = percent(N / nrow(.))) %>%
  ungroup() %>%
  arrange(desc(N)) %>% 
  formattable()
phage_or_virus %>% 
  as.datatable(rownames = FALSE, caption = "Number of sequence reads belonging to virus or bacteriophage classes. Unclassified taxa are shown by name.")
```

### Source
<a download="taxonomy_report.Rmd" href="`r base64enc::dataURI(file = params$rmd, mime = 'text/rmd', encoding = 'base64')`">R Markdown source file (to produce this document)</a>

